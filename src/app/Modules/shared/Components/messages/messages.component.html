<div class="flex h-screen bg-gray-900 text-white p-4 gap-4">
  <!-- LEFT: Following List -->
  <div class="w-1/4 border-r border-gray-700 bg-gray-800 rounded-lg shadow-lg p-5">
    <h2 class="text-xl font-semibold">Following</h2>

    <!-- Search Bar -->
    <div class="mt-4">
      <input type="text" [(ngModel)]="searchTerm" placeholder="Search users..."
        class="w-full p-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <!-- Users List -->
    <div *ngFor="let user of filteredUsers()"
      class="p-3 cursor-pointer flex items-center gap-3 hover:bg-gray-700 transition rounded-lg mt-2"
      (click)="selectUser(user)">
      <img [src]="noPicture" alt="{{ noPicture }}" class="w-12 h-12 rounded-full border-2 border-blue-500">
      <div>
        <p class="font-medium text-lg">{{ user.username }}</p>
      </div>
    </div>
  </div>

  <!-- CENTER: Chat Section -->
  <div class="flex-1 flex flex-col rounded-lg shadow-lg bg-gray-800 p-5" *ngIf="selectedUser">
    <!-- Chat Header -->
    <div class="p-4 border-b border-gray-700 bg-gray-700 flex items-center gap-3 rounded-t-lg">
      <img *ngIf="selectedUser" [src]="noPicture" alt="{{ noPicture }}"
        class="w-12 h-12 rounded-full border-2 border-blue-500">
      <p (click)="openProfile(selectedUser.userId, true)" class="text-lg font-semibold">{{ selectedUser?.username }}</p>
      <div class="ml-auto flex items-center gap-3">
        <!-- <app-video-chat></app-video-chat> -->
        <mat-icon (click)="openChatGpt()" class="cursor-pointer">help</mat-icon>
      </div>
    </div>

    <!-- ChatGPT Box -->
    <!-- ChatGPT Box -->
    <div *ngIf="openGptBox" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
      <div class="bg-gray-800 text-white p-5 rounded-lg shadow-lg max-w-md w-full">
        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
          <h2 class="text-lg font-semibold">ChatGPT Assistant</h2>
          <mat-icon (click)="openChatGpt()" class="cursor-pointer">close</mat-icon>
        </div>

        <!-- Input Field -->
        <div class="mt-4">
          <input [(ngModel)]="userMessage" class="w-full p-2 rounded bg-gray-700 text-white"
            placeholder="Ask ChatGPT...">
        </div>

        <!-- Buttons Section -->
        <div class="mt-2 flex gap-2">
          <button (click)="analyzeMessage()" class="flex-1 bg-yellow-500 text-white py-2 rounded">
            Analyze
          </button>
      
          <button (click)="generateGPTMessage()"class="bg-blue-500 px-4 py-2 flex justify-center items-center rounded-lg text-lg gptSend"><mat-icon>send</mat-icon></button>
        </div>
        

        <!-- ChatGPT Response -->
        <div class="mt-4">
          <h3 class="text-sm font-semibold">Response:</h3>
          <p *ngIf="isLoading" class="text-gray-400">Generating response...</p>
        
          <!-- Editable Input Box for AI Response -->
          <textarea 
            *ngIf="aiResponse" 
            [(ngModel)]="aiResponse" 
            class="mt-2 bg-gray-600 p-2 rounded w-full text-white border border-gray-400 textArea"
            rows="4">
          </textarea>
        </div>
        

        <!-- Reply to Chat Button -->
        <div *ngIf="aiResponse" class="mt-3">
          <button (click)="replyToChat()" class="w-full bg-green-500 text-white py-2 rounded">
            Reply to Chat
          </button>
        </div>
      </div>
    </div>


    <!-- Chat Messages Container -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 rounded-md chat-container">
      <div *ngFor="let msg of messages" class="flex items-start"
        [ngClass]="{'justify-end': msg.senderId === userID, 'justify-start': msg.senderId !== userID}">

        <!-- Message Bubble -->
        <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow-md message-bubble" 
          [ngClass]="{'bg-blue-500 text-white': msg.senderId === userID, 'bg-gray-700 text-white': msg.senderId !== userID}">

          <!-- Text Message -->
          <p *ngIf="msg.messageType === MessageType.Text" class="text-white textMessageArea">{{msg.content}}</p>

          <div *ngIf="msg.messageType === MessageType.Image && !msg.files?.length" >
            <img [src]="msg.content" alt="Sent Image" class="rounded-lg w-[15rem] h-[15rem]">
         </div>         

          <!-- Video Preview -->
          <div *ngIf="msg.messageType === MessageType.Video">
            <video controls class="rounded-lg max-w-full">
              <source [src]="msg.content" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>

          <div *ngIf="msg.messageType === FileType.Audio">
            <audio controls class="rounded-lg max-w-full">
              <source [src]="msg.content" type="audio/mp3">
              Your browser does not support the audio element.
            </audio>
          </div>

          <!-- Document Download -->
          <div *ngIf="msg.messageType === FileType.File" class="flex items-center gap-2">
            <mat-icon>insert_drive_file</mat-icon>
            <a [href]="msg.content" download="{{ msg.content }}" class="text-blue-300 hover:underline">{{
              msg.content }}</a>
          </div>

          <!-- Image Preview -->
          <div *ngFor="let file of msg.files">
            <!-- Image Preview -->
            <div *ngIf="file.fileType === FileType.Image">
              <img [src]="file.fileContent" alt="Sent Image2" class="rounded-lg w-[15rem] h-[15rem]">
            </div>

            <!-- Video Preview -->
            <div *ngIf="file.fileType === FileType.Video">
              <video controls class="rounded-lg max-w-full">
                <source [src]="file.fileContent" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>

            <!-- Audio Preview -->
            <div *ngIf="file.fileType === FileType.Audio">
              <audio controls class="rounded-lg max-w-full">
                <source [src]="file.fileContent" type="audio/mp3">
                Your browser does not support the audio element.
              </audio>
            </div>

            <!-- Document Download -->
            <div *ngIf="file.fileType === FileType.File" class="flex items-center gap-2">
              <mat-icon>insert_drive_file</mat-icon>
              <a [href]="file.fileContent" download="{{ file.fileName }}" class="text-blue-300 hover:underline">{{
                file.fileName }}</a>
            </div>
          </div>


          <!-- Timestamp -->
          <p class="text-xs mt-1 text-gray-300 text-right">
            {{ msg.timestamp | date: 'dd MMM, h:mm a' }}
          </p>          
        </div>   
        <div class="relative group">
          <!-- Three Dots Icon (Hidden by Default, Visible on Hover) -->
          <mat-icon *ngIf="msg.senderId === userID"
            class="absolute top-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer verticalDots"
            (click)="openOptions(msg._id)">more_vert
          </mat-icon>
        
          <!-- Dropdown Options -->
          <div *ngIf="selectedMessageId === msg._id " 
               class="absolute top-5 right-0 bg-gray-800 text-white shadow-lg rounded-md p-2 w-24">
            <!-- <p (click)="editMessageFromChats(msg._id!, 'Default Content')" *ngIf="msg.messageType === MessageType.Text"
               class="cursor-pointer hover:bg-gray-600 p-1">‚úèÔ∏è Edit</p> -->
            <p (click)="deleteMessageFromChats(msg._id!)" 
               class="cursor-pointer hover:bg-gray-600 p-1 deleteIcon">üóëÔ∏è Delete</p>
          </div>
        </div>
        
      </div>
    </div>


    <!-- Message Input Section -->
    <div class="p-4 border-t border-gray-600 flex items-center gap-4 bg-gray-600 rounded-b-lg relative">
      <!-- File Upload -->
      <mat-icon (click)="toggleAttachments()" class="text-white text-xl cursor-pointer px-4">attach_file</mat-icon>

      <!-- Attachment Menu (Opens Right Above Icon) -->
      <div *ngIf="showAttachmentOptions"
        class="absolute bottom-full left-0 mb-2 w-[18rem] bg-gray-600 p-3 rounded-lg shadow-lg flex flex-col gap-2 transition-transform duration-300 origin-bottom"
        [ngClass]="{'scale-100 opacity-100': showAttachmentOptions, 'scale-90 opacity-0': !showAttachmentOptions}">

        <label class="cursor-pointer flex items-center gap-3 p-2 hover:bg-gray-700 rounded transition">
          <mat-icon>add_photo_alternate</mat-icon> Images
          <input type="file" accept="image/*" (change)="sendFile($event, FileType.Image)" hidden>
        </label>

        <label class="cursor-pointer flex items-center gap-3 p-2 hover:bg-gray-700 rounded transition">
          <mat-icon>videocam</mat-icon> Video
          <input type="file" accept="video/*" (change)="sendFile($event, FileType.Video)" hidden>
        </label>

        <label class="cursor-pointer flex items-center gap-3 p-2 hover:bg-gray-700 rounded transition">
          <mat-icon>picture_as_pdf</mat-icon> Documents
          <input type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" (change)="sendFile($event, FileType.File)" hidden>
        </label>

        <label class="cursor-pointer flex items-center gap-3 p-2 hover:bg-gray-700 rounded transition">
          <mat-icon>equalizer</mat-icon> Audio
          <input type="file" accept="audio/*" (change)="sendFile($event, FileType.Audio)" hidden>
        </label>
      </div>

      <!-- Emoji Picker -->
      <mat-icon (click)="toggleEmojiPicker()">mood</mat-icon>

      <!-- Emoji Picker -->
      <div class="relative" *ngIf="showEmojiPicker">
        <emoji-mart (emojiSelect)="addEmoji($event)"
          [style]="{ position: 'absolute', bottom: '40px', right: '10px' }"></emoji-mart>
      </div>


      <!-- Message Input -->
      <input [(ngModel)]="newMessage" class="flex-1 p-3 bg-gray-600 text-white rounded-lg outline-none newMessage"
        placeholder="Type a message...">

      <!-- Voice Message -->
      <!-- <mat-icon (mousedown)="startRecording()" class="text-xl px-4">mic</mat-icon> -->

      <!-- Send Button -->
      <button (click)="sendMessage()" class="bg-blue-500 px-4 py-2 flex justify-center items-center rounded-lg text-lg sendMessage"><mat-icon>send</mat-icon></button>
    </div>
  </div>

<!-- RIGHT: User Profile Section -->
<div class="w-1/4 border-l border-gray-700 bg-gray-800 rounded-lg shadow-lg p-6 profile-section" *ngIf="user">
  <div class="flex flex-col items-center text-center">
    <img [src]="user.profile_picture_url" alt="{{ user.username }}" (click)="openProfile(user.instagram_id, true)"
      class="w-28 h-28 rounded-full border-4 border-blue-500 shadow-md">

    <h2 class="text-xl font-semibold mt-4 text-white">{{ user.username }}</h2>
    <p class="text-gray-400 text-sm">{{ user.bio }}</p>
  </div>

  <div class="mt-6 border-t border-gray-600 pt-4">
    <h3 class="text-lg font-medium text-gray-300 mb-3">Activity</h3>
    <p class="text-gray-400 text-sm">Followers: {{ user.followers_data.length }}</p>
    <p class="text-gray-400 text-sm">Following: {{ user.following_data.length }}</p>
  </div>

  <div class="mt-6 flex justify-between">
    <div>
    <button (click)="activeTab = 'following'"
      [class.bg-gray-500]="activeTab === 'following'"
      class="px-4 py-2 bg-transparent text-gray-400 border border-gray-300 rounded-lg hover:bg-gray-500 hover:text-gray-800 transition">
      Following
    </button>
  </div>
  <div>
    <button (click)="activeTab = 'followers'"
      [class.bg-gray-500]="activeTab === 'followers'"
      class="px-4 py-2 bg-transparent text-gray-400 border border-gray-300 rounded-lg hover:bg-gray-500 hover:text-gray-800 transition">
      Followers
    </button>
  </div>
  <div>
    <button (click)="activeTab = 'media'"
      [class.bg-gray-500]="activeTab === 'media'"
      class="px-4 py-2 bg-transparent text-gray-400 border border-gray-300 rounded-lg hover:bg-gray-500 hover:text-gray-800 transition">
      Posts
    </button>
  </div>
  </div>

  <!-- Following List -->
  <div class="mt-4 border-t border-gray-600 pt-4" *ngIf="activeTab === 'following'">
    <h3 class="text-lg font-medium text-gray-300 mb-3">Following</h3>
    <ul class="text-gray-400 text-sm" *ngIf="user.following_data!.length > 0; else noFollowing">
      <li *ngFor="let person of user.following_data" >
        {{ person.username }}
      </li>
    </ul>
    <ng-template #noFollowing>
      <p class="text-gray-400 text-sm">No data available</p>
    </ng-template>
  
  </div>

  <!-- Followers List -->
  <div class="mt-4 border-t border-gray-600 pt-4" *ngIf="activeTab === 'followers'">
    <h3 class="text-lg font-medium text-gray-300 mb-3">Followers</h3>
    <ul class="text-gray-400 text-sm" *ngIf="user!.followers_data!.length > 0; else noFollowing">
      <li *ngFor="let person of user.followers_data">
        {{ person.username }}
      </li>
    </ul>
    <ng-template #noFollowing>
      <p class="text-gray-400 text-sm">No data available</p>
    </ng-template>
  </div>

  <!-- Default Media View -->
  <div class="mt-6 border-t border-gray-600 pt-4" *ngIf="activeTab === 'media'">
    <h3 class="text-lg font-medium text-gray-300 mb-3">Media</h3>
    <div class="grid grid-cols-3 gap-2" *ngIf="user!.media!.length > 0; else noMedia">
      <div *ngFor="let item of user.media" class="relative">
        <img [src]="item.media_url" alt="Post" class="w-full h-28 object-cover rounded-lg shadow-md">
      </div>
    </div>
    <ng-template #noMedia>
      <p class="text-gray-400 text-sm">No data available</p>
    </ng-template>
  </div>
</div>



</div>